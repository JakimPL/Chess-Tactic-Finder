<!doctype html>
<html>
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <title>Tactic player</title>
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css" integrity="sha384-q94+BZtLrkL1/ohfjR8c6L+A6qzNH9R2hBLwyoAfu3i/WCvQjzL2RQJ3uNHDISdU" crossorigin="anonymous">
    <style>
    .column {
        float: left;
        width: 50%;
    }

    .row:after {
        content: "";
        display: table;
        clear: both;
    }
</style>
</head>
<body>

<div class="row">
    <div class="column" style="position: fixed; width: 500px; height: 100%">
        <div id="myBoard" style="margin:0 auto; width: 400px"></div>
        <div id="buttons" style="text-align:center; display: block">
            <button id="reset" type="button">Reset puzzle</button>
            <button id="hint" type="button">Hint</button>
            <button id="solution" type="button">Solution</button>
            <button id="copyFEN" type="button">Copy FEN</button>
            <button id="copyPGN" type="button">Copy PGN</button>
        </div>

        <div id="progress">&nbsp</div>
        <div id="status"></div>
        <div id="moves"></div>
    </div>
    <div class="column" style="height: 100%; overflow: auto; margin-left: 500px; font-size: 10px;">
        <div id="puzzles">
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.4.1.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
<script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js" integrity="sha384-8Vi8VHwn3vjQ9eUHUxex3JSN/NFqUg3QbPyX8kWyb93+8AC/pPWTzj+nHtbC5bxD" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.2/chess.js" integrity="sha384-s3XgLpvmHyscVpijnseAmye819Ee3yaGa8NxstkJVyA6nuDFjt59u1QvuEl/mecz" crossorigin="anonymous"></script>
<script src="https://unpkg.com/chess-pgn-parser/dist/parser.js"></script>
<script src="https://www.kryogenix.org/code/browser/sorttable/sorttable.js"></script>
<script src="js/tactic.js"></script>

<script>

var puzzles = null
var path = null
var board = null
var tactic = null
var game = null

var $status = $('#status')
var $moves = $('#moves')
var $progress = $('#progress')

var pgn = null
var fen = null

var wait = false
var delayTime = 750

$('#reset').on('click', function() {
    reset()
})

$('#hint').on('click', function() {
    if (tactic !== null) {
        if (!tactic.solved) {
            move = game.move(tactic.nextMove)
            game.undo()
            $progress.html('Hint: ' + getFullPieceName(move.piece))
            hint = true

            delay(() => {
                $progress.html('&nbsp')
            })
        }
    }
})

$('#solution').on('click', function() {
    if (tactic !== null) {
        if (!tactic.solved) {
            $progress.html('Hint: ' + tactic.nextMove)
            hint = false

            delay(() => {
                $progress.html('&nbsp')
            })
        }
    }
})

$('#copyFEN').on('click', function() {
    if (fen !== null) {
        navigator.clipboard.writeText(fen)
    }
})

$('#copyPGN').on('click', function() {
    if (fen !== pgn) {
        navigator.clipboard.writeText(pgn)
    }
})

function loadPuzzles(path) {
    fetch(path)
    .then(response => response.text())
    .then(text => {
        puzzles = JSON.parse(text)
        createPuzzleTable(puzzles)
    })
}

function createPuzzleTable(puzzles) {
    var table = '<table class="sortable" id="puzzleList">'
    table += `
    <thead>
        <tr>
            <th>Play</th>
            <th>White</th>
            <th>Black</th>
            <th>Date</th>
            <th>Puzzle type</th>
            <th>Moves</th>
            <th>Hardness</th>
            <th>Initial evaluation
            </th>
        </tr>
    </thead>
    <tbody>
    `
    for (var i = 0; i < puzzles.length; i++) {
        var puzzle = puzzles[i]
        table += '<tr>'
        table += `<td><a href="javascript:loadPGN('` + puzzle.path + `')" style="text-decoration:none">&#9654;</a>`
        table += '<td>' + puzzle.white + '</td>'
        table += '<td>' + puzzle.black + '</td>'
        table += '<td>' + puzzle.date + '</td>'
        table += '<td>' + puzzle.puzzleType + '</td>'
        table += '<td>' + puzzle.moves + '</td>'
        table += '<td>' + puzzle.hardness.toFixed(2) + '</td>'
        table += '<td>' + puzzle.initialEvaluation + '</td>'
        table += '</tr>'
    }
    table += '</tbody></table>'

    $('#puzzles').html(table)
    var tableObject = document.getElementById('puzzleList')
    sorttable.makeSortable(tableObject)
}

function getFullPieceName(piece) {
    piece = piece.toLowerCase()
    switch (piece) {
        case 'p':
            return 'Pawn'
        case 'n':
            return 'Knight'
        case 'b':
            return 'Bishop'
        case 'r':
            return 'Rook'
        case 'q':
            return 'Queen'
        case 'k':
            return 'King'
    }
}

function loadPGN(path) {
    fetch(path)
    .then(response => response.text())
    .then(text => {
        pgn = text
        reset()
    })
}

function makeMove(move) {
	if (move !== null) {
		move = game.move(move)
		uci = move.from + '-' + move.to
		board.move(uci)
	}
}

function getMoves() {
    moves = game.moves({verbose: true})
    return game.pgn().split(/\d+\./).slice(1).join('')
}

function delay(callback) {
    wait = true
    setTimeout(() => {
        callback()
        wait = false
        updateStatus()
    }, delayTime);
}

function checkIfSolved() {
    if (tactic.solved) {
        $progress.html('Puzzle solved!')
    }
}

function onDragStart (source, piece, position, orientation) {
	// do not pick up pieces if the game is over
	if (wait || tactic.solved || game.game_over()) return false

	// only pick up pieces for the side to move
	if ((game.turn() === 'w' && piece.search(/^b/) !== -1) ||
		(game.turn() === 'b' && piece.search(/^w/) !== -1)) {
		return false
	}
}

function onDrop(source, target) {
	// see if the move is legal
	var move = game.move({
		from: source,
		to: target,
		promotion: 'q' // NOTE: always promote to a queen for example simplicity
	})

	if (wait || move === null) {
		return 'snapback'
	} else {
		nextMove = tactic.nextMove
		if (nextMove != move.san) {
			$progress.html('Incorrect move!')
			delay(() => {
				game.undo()
				board.position(game.fen())
				$progress.html('&nbsp')
			})
		}
		else {
			move = tactic.getNextMove()
			if (move !== null) {
				delay(() => {
                    makeMove(move)
                    tactic.getNextMove()
                })
			}
		}
	}

	updateStatus()
}

// update the board position after the piece snap
// for castling, en passant, pawn promotion
function onSnapEnd () {
	board.position(game.fen())
}

function updateStatus () {
	var status = ''

	var moveColor = 'White'
	if (game.turn() === 'b') {
		moveColor = 'Black'
	}

	// checkmate?
	if (game.in_checkmate()) {
		status = 'Game over, ' + moveColor + ' is in checkmate.'
	}

	// draw?
	else if (game.in_draw()) {
		status = 'Game over, drawn position'
	}

	// game still on
	else {
		status = moveColor + ' to move'
	}

	$status.html(status)
	$moves.html(getMoves())
    checkIfSolved()
}

function getConfig(tactic) {
    return {
        draggable: true,
        position: tactic.fen,
        onDragStart: onDragStart,
        onDrop: onDrop,
        onSnapEnd: onSnapEnd
    }
}

function reset() {
    $progress.html('&nbsp')

    tactic = new Tactic(pgn)
    game = new Chess(tactic.fen)
    board = Chessboard('myBoard', getConfig(tactic))

    fen = game.fen()

    if (game.turn() == 'w') {
        board.flip()
    }

    updateStatus()
    delay(() => {
        makeMove(tactic.firstMove)
    })
}

board = Chessboard('myBoard')
loadPuzzles('games.json')

</script>
</body>
</html>
