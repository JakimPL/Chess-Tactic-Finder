<!doctype html>
<html>
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <title>Tactic player</title>
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css" integrity="sha384-q94+BZtLrkL1/ohfjR8c6L+A6qzNH9R2hBLwyoAfu3i/WCvQjzL2RQJ3uNHDISdU" crossorigin="anonymous">
    <style>
    a:link, a:hover, a:visited, a:active {
       text-decoration: none
    }

    .column {
        float: left;
        width: 50%;
    }

    .row:after {
        content: "";
        display: table;
        clear: both;
    }
</style>
</head>
<body>

<div class="row">
    <div class="column" style="position: fixed; width: 500px; height: 100%">
        <div id="myBoard" style="margin:0 auto; width: 400px"></div>
        <div id="buttons" style="text-align:center; display: block">
            <button id="backward" type="button">&#9664;</button>
            <button id="reset" type="button">Reset puzzle</button>
            <button id="hint" type="button">Hint</button>
            <button id="solution" type="button">Solution</button>
            <button id="copyFEN" type="button">Copy FEN</button>
            <button id="copyPGN" type="button">Copy PGN</button>
            <button id="forward" type="button">&#9654;</button>
        </div>

        <div id="panel">&nbsp</div>
        <div id="status"></div>
        <div id="moveHistory"></div>
    </div>
    <div class="column" style="height: 100%; overflow: auto; margin-left: 500px; font-size: 10px;">
        <div id="refresh"><h2><a href="javascript: refresh()">&#10227;</a> Games</h2> </div>
        <div id="puzzles">
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.4.1.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
<script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js" integrity="sha384-8Vi8VHwn3vjQ9eUHUxex3JSN/NFqUg3QbPyX8kWyb93+8AC/pPWTzj+nHtbC5bxD" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.2/chess.js" integrity="sha384-s3XgLpvmHyscVpijnseAmye819Ee3yaGa8NxstkJVyA6nuDFjt59u1QvuEl/mecz" crossorigin="anonymous"></script>
<script src="https://unpkg.com/chess-pgn-parser/dist/parser.js"></script>
<script src="https://www.kryogenix.org/code/browser/sorttable/sorttable.js"></script>
<script src="js/tactic.js"></script>
<script src="js/main.js"></script>

<script>

board = Chessboard('myBoard')

var $status = $('#status')
var $moveHistory = $('#moveHistory')
var $panel = $('#panel')

$('#refresh').on('click', function() {
    refresh()
})

$('#reset').on('click', function() {
    setPanel()
    reset()
})

$('#hint').on('click', function() {
    if (tactic !== null) {
        if (!tactic.solved) {
            move = game.move(tactic.nextMove)
            game.undo()
            setPanel('Hint: ' + getFullPieceName(move.piece))
            delay(() => {setPanel()})
        }
    }
})

$('#solution').on('click', function() {
    if (tactic !== null) {
        if (!tactic.solved) {
            setPanel('Hint: ' + tactic.nextMove)
            delay(() => {setPanel()})
        }
    }
})

$('#copyFEN').on('click', function() {
    if (fen !== null) {
        navigator.clipboard.writeText(fen)
    }
})

$('#copyPGN').on('click', function() {
    if (fen !== pgn) {
        navigator.clipboard.writeText(pgn)
    }
})

function setPanel(text) {
    if (text == null) {
        $panel.html('&nbsp')
    } else {
        $panel.html(text)
    }
}

function loadPuzzles() {
    fetch(progressPath)
    .then(response => response.text())
    .then(text => {
        progress = JSON.parse(text)
    })

    fetch(puzzlesPath)
    .then(response => response.text())
    .then(text => {
        puzzles = JSON.parse(text)
        createPuzzleTable(puzzles)
    })
}

function createPuzzleTable(puzzles) {
    var table = '<table class="sortable" id="puzzleList">'
    table += `
    <thead>
        <tr>
            <th>Play</th>
            <th>Solved?</th>
            <th>White</th>
            <th>Black</th>
            <th>Date</th>
            <th>Puzzle type</th>
            <th>Moves</th>
            <th>Hardness</th>
            <th>Evaluation
            </th>
        </tr>
    </thead>
    <tbody>
    `

    for (var i = 0; i < puzzles.length; i++) {
        var puzzle = puzzles[i]
        table += '<tr>'
        table += `<td><a href="javascript:loadPGN('` + puzzle.path + `', '` + puzzle.hash + `')">&#9654;</a>`
        table += '<td id=puzzle' + puzzle.hash + '>'

        if (progress[puzzle.hash]) {
            table += '&#10003;'
        }

        table += '</td>'
        table += '<td>' + puzzle.white + '</td>'
        table += '<td>' + puzzle.black + '</td>'
        table += '<td>' + puzzle.date + '</td>'
        table += '<td>' + puzzle.puzzleType + '</td>'
        table += '<td>' + puzzle.moves + '</td>'
        table += '<td>' + puzzle.hardness.toFixed(2) + '</td>'
        table += '<td>' + puzzle.initialEvaluation + '</td>'
        table += '</tr>'
    }
    table += '</tbody></table>'

    $('#puzzles').html(table)
    var tableObject = document.getElementById('puzzleList')
    sorttable.makeSortable(tableObject)
}

function save(hash) {
    $('#puzzle' + currentPuzzleId).html('&#10003;')
    progress[currentPuzzleId] = true
    $.ajax({
        url: 'save/' + hash,
        type: 'GET',
        success: () => {},
        error: () => {
            console.error('No response from server')
        }
    })
}

function refresh() {
    $.ajax({
        url: 'refresh',
        type: 'GET',
        success: () => {
            loadPuzzles()
        },
        error: () => {
            console.error('Unable to refresh puzzles')
        }
    })
}

panelTextCallback = setPanel
statusTextCallback = (text) => {$status.html(text)}
moveHistoryTextCallback = (text) => {$moveHistory.html(text)}
refresh()

</script>
</body>
</html>
