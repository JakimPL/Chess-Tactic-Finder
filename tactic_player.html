<!doctype html>
<html>
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <title>Tactic player</title>
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css" integrity="sha384-q94+BZtLrkL1/ohfjR8c6L+A6qzNH9R2hBLwyoAfu3i/WCvQjzL2RQJ3uNHDISdU" crossorigin="anonymous">
</head>
<body>

<div id="myBoard" style="width: 400px"></div>
<div id="buttons">
    <button id="reset" type="button">Reset puzzle</button>
    <button id="hint" type="button">Hint</button>
</div>

<div id="progress">&nbsp</div>
<div id="status"></div>
<div id="pgn"></div>

<script src="https://code.jquery.com/jquery-3.4.1.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
<script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js" integrity="sha384-8Vi8VHwn3vjQ9eUHUxex3JSN/NFqUg3QbPyX8kWyb93+8AC/pPWTzj+nHtbC5bxD" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.2/chess.js" integrity="sha384-s3XgLpvmHyscVpijnseAmye819Ee3yaGa8NxstkJVyA6nuDFjt59u1QvuEl/mecz" crossorigin="anonymous"></script>
<script src="https://unpkg.com/chess-pgn-parser/dist/parser.js"></script>
<script src="js/tactic.js"></script>

<script>
var pgn = `
[Event "Live Chess"]
[Site "Chess.com"]
[Date "2011.08.04"]
[Round "-"]
[White "dmonev"]
[Black "JakimPL"]
[Result "1-0"]
[FEN "4k3/5p2/5P2/2p3K1/P7/1PBP3P/2P5/8 b - - 2 43"]
[SetUp "1"]
[WhiteElo "1539"]
[BlackElo "1483"]
[TimeControl "900+10"]
[Termination "dmonev won by checkmate"]
[EndTime "7:51:40 PDT"]

43... Kf8 44. a5 Ke8 45. a6 Kd8 46. a7 Kc8 47. a8=Q+ Kc7 1-0
`

var board = null
var tactic = new Tactic(pgn)
var game = new Chess(tactic.fen)
var $status = $('#status')
var $fen = $('#fen')
var $pgn = $('#pgn')
var $progress = $('#progress')

var wait = false
var delay_time = 750

$('#reset').on('click', function() {
    reset()
})

$('#hint').on('click', function() {
    board.highlight('e2')
})

function make_move(move) {
	if (move !== null) {
		move = game.move(move)
		uci = move.from + '-' + move.to
		board.move(uci)
	}
}

function delay(callback) {
    wait = true
    setTimeout(() => {
        callback()
        wait = false
        updateStatus()
    }, delay_time);
}

function checkIfSolved() {
    if (tactic.solved) {
        $progress.html('Puzzle solved!')
    } else{
        //$progress.html('&nbsp')
    }
}

function onDragStart (source, piece, position, orientation) {
	// do not pick up pieces if the game is over
	if (wait || tactic.solved || game.game_over()) return false

	// only pick up pieces for the side to move
	if ((game.turn() === 'w' && piece.search(/^b/) !== -1) ||
		(game.turn() === 'b' && piece.search(/^w/) !== -1)) {
		return false
	}
}

function onDrop(source, target) {
	// see if the move is legal
	var move = game.move({
		from: source,
		to: target,
		promotion: 'q' // NOTE: always promote to a queen for example simplicity
	})

	if (wait || move === null) {
		return 'snapback'
	} else {
		next_move = tactic.next_move
		if (next_move != move.san) {
			$progress.html('Incorrect move!')
			delay(() => {
				game.undo()
				board.position(game.fen())
				$progress.html('&nbsp')
			})
		}
		else {
			move = tactic.get_next_move()
			if (move !== null) {
				delay(() => {
                    make_move(move)
                    tactic.get_next_move()
                })
			}
		}
	}

	updateStatus()
}

// update the board position after the piece snap
// for castling, en passant, pawn promotion
function onSnapEnd () {
	board.position(game.fen())
}

function updateStatus () {
	var status = ''

	var moveColor = 'White'
	if (game.turn() === 'b') {
		moveColor = 'Black'
	}

	// checkmate?
	if (game.in_checkmate()) {
		status = 'Game over, ' + moveColor + ' is in checkmate.'
	}

	// draw?
	else if (game.in_draw()) {
		status = 'Game over, drawn position'
	}

	// game still on
	else {
		status = moveColor + ' to move'
	}

	$status.html(status)
	$pgn.html(game.pgn())
    checkIfSolved()
}

var config = {
	draggable: true,
	position: tactic.fen,
	onDragStart: onDragStart,
	onDrop: onDrop,
	onSnapEnd: onSnapEnd
}

function reset() {
    tactic = new Tactic(pgn)
    game = new Chess(tactic.fen)
    board = Chessboard('myBoard', config)

    updateStatus()
    delay(() => {
        make_move(tactic.first_move)
    })
}

reset()

</script>
</body>
</html>
