<!doctype html>
<html>
<head>
    <title>Chess Tactic Finder</title>
    <meta charset="utf-8"/>
    <meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible"/>
    <meta content="width=device-width, initial-scale=1, user-scalable=no" name="viewport"/>

    <link href="img/chesspieces/wikipedia/wB.png" rel="icon" type="image/png">
    <link href="css/style.css" rel="stylesheet">

    <script src="js/import/jquery-3.4.1.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
    <script src="js/common.js"></script>
</head>

<body>

<div class="row">
    <div class="column">
        <div><h3>Installation</h3></div>
        <div><p>Download:</p>
            <ul>
                <li><a href="https://www.python.org/downloads/release/python-3100/">Python 3.10</a></li>
                <li><a href="https://stockfishchess.org/download/">Stockfish</a></li>
                <li><a href="https://www.cs.kent.ac.uk/people/staff/djb/pgn-extract/">pgn-extract</a></li>
            </ul>
        </div>
        <div><p>Set paths:</p>
            <div id="paths">
                <table>
                    <tr>
                        <td>&#9818;</td>
                        <td><label for="stockfish">Stockfish</label></td>
                        <td><input id="stockfish" type="text"></td>
                    </tr>
                    <tr>
                        <td>&#9817;</td>
                        <td><label for="pgn_extract">pgn-extract</label></td>
                        <td><input id="pgn_extract" type="text"></td>
                    </tr>
                </table>
            </div>
        </div>
        <div><p>Chess Tactic Finder:</p>
            <div class="buttons">
                <button id="reinstall" type="button">&#9654; Reinstall Tactic Finder</button>
                <button id="tactic_player" type="button"><a href="tactic_player.html" target="_blank">&#9654; Run Tactic Player</a></button>
            </div>
        </div>
    </div>
    <div class="column">
        <div><h3>Game analysis</h3></div>
        <div><p>Analyze a game:</p>
            <div><input id="pgn" type="file" accept=".pgn"></div>
            <div class="buttons">
                <button id="start">Start</button>
            </div>
        </div>
    </div>
</div>

<script>

var configuration = null

var installation = false
var analysis = false

var stockfishPath = ''
var pgnExtractPath = ''

$('#stockfish').on('change', function() {
    configuration['paths']['stockfish'] = $(this).val()
    saveConfiguration(configuration)
})

$('#pgn_extract').on('change', function() {
    configuration['paths']['pgn_extract'] = $(this).val()
    saveConfiguration(configuration)
})

$('#start').on('click', function() {
    if (analysis) {
        return
    }

    var reader = new FileReader()
    var fileElement = document.getElementById('pgn')
    var file = fileElement.files[0]

    if (file == null) {
        alert('No file selected.')
        return
    }

    reader.readAsText(file)
    reader.onload = function(event) {
        var pgn = event.target.result
        analysis = true
        $.ajax({
            url: 'analyze',
            type: 'POST',
            data: pgn,
            success: () => {
                analysis = false
            },
            error: () => {
                analysis = false
            }
        })
    }
})

$('#reinstall').on('click', function() {
    if (installation) {
        return
    }

    installation = true
    markButton('reinstall')
    $.ajax({
        url: 'reinstall',
        type: 'GET',
        success: () => {
            alert('Tactic Finder reinstalled.')
            unmarkButton('reinstall')
            installation = false
        },
        error: () => {
            alert('Failed to reinstall a Tactic Finder.')
            unmarkButton('reinstall')
            installation = false
        }
    })
})

function saveConfiguration(configuration) {
    $.ajax({
        url: 'save_configuration',
        type: 'POST',
        data: JSON.stringify(configuration),
        contentType: "application/json; charset=utf-8",
        success: () => {
            console.log('Configuration saved.')
        },
        error: () => {
            console.error('Failed to save configuration.')
        }
    })
}

function loadConfiguration() {
    fetch('configuration.json', {cache: 'no-cache'})
    .then(response => response.json())
    .then(json => {
        configuration = json
        stockfishPath = configuration['paths']['stockfish']
        pgnExtractPath = configuration['paths']['pgn_extract']
        document.getElementById('stockfish').value = stockfishPath
        document.getElementById('pgn_extract').value = pgnExtractPath
    })
}

loadConfiguration()

</script>

<footer>
    <a href="https://github.com/JakimPL/Chess-Tactic-Finder/">Tactic Finder by Jakim (2023).</a>
</footer>

</body>
</html>
